<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NYC Fleet EV Map (Live via GitHub CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .legend, .controls {
      background: white; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25); font: 14px/1.2 system-ui, -apple-system, Arial, sans-serif;
    }
    .legend .row { display: flex; align-items: center; margin-bottom: 4px; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid #3333; }
    .controls label { display: block; margin: 3px 0; }

    .bolt-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #222;
      color: #fff;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      transform: translate(-1px, -1px);
    }

    /* COLORS BY CHARGER TYPE */
    .bolt-l3 { background: #16a34a; }     /* Level 3 → green */
    .bolt-l2 { background: #2563eb; }     /* Level 2 → blue */
    .bolt-solar { background: #facc15; color: #111; } /* Solar → yellow */
    .bolt-public { background: #f97316; } /* Public → orange */

    .leaflet-div-icon { background: transparent; border: none; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var map = L.map('map').setView([40.7128, -74.0060], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // CSV from GitHub Raw (cache-busted)
    var CSV_URL = 'https://raw.githubusercontent.com/FlashE24V/Fleet-Map/main/status_latest_slim.csv?v=' + Date.now();

    function pick(r, keys) {
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        if (r[k] !== undefined && r[k] !== null && r[k] !== '') return r[k];
      }
      return undefined;
    }

    // Normalize to: Available | In Use | Needs Service | Unreachable
    function normalizeToInUse(text) {
      if (!text) return 'Unknown';
      var t = ('' + text).toUpperCase();
      if (t.includes('AVAILABLE')) return 'Available';
      if (t.includes('CHARGING')) return 'In Use';
      if (t.includes('OCCUPIED') || t === 'INUSE') return 'In Use';
      if (t.includes('NEEDS SERVICE') || t.includes('NEED SERVICE')) return 'Needs Service';
      if (t.includes('UNREACHABLE') || t.includes('UNAVAILABLE') || t.includes('DOWN') || t.includes('OFFLINE')) return 'Unreachable';
      return text;
    }

    // Derive final status for a row, prioritizing network status = Unreachable
    function deriveStatus(r) {
      var stationLabel = pick(r, ['station_label']);
      var lastPort     = pick(r, ['LastPortStatus','status']); // fallback
      var net          = pick(r, ['StationNetworkStatus','networkStatus','NetworkStatus']);
      var fault        = pick(r, ['faultReason']);

      if (net) {
        var n = ('' + net).toUpperCase();
        if (n.includes('UNREACHABLE') || n.includes('UNAVAILABLE') || n.includes('OFFLINE') || n.includes('DOWN')) {
          return 'Unreachable';
        }
      }

      var base = stationLabel != null && stationLabel !== '' ? stationLabel : lastPort;

      if (fault) {
        var f = ('' + fault).toUpperCase();
        if (f.includes('NEEDS SERVICE') || f.includes('NEED SERVICE')) return 'Needs Service';
      }

      return normalizeToInUse(base);
    }

    function chargerTypeFromRow(r) {
      var v = pick(r, ['Charger type (legend)', 'Charg]()
