<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NYC Fleet EV Map (Live via GitHub CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .legend, .controls {
      background: white; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25); font: 14px/1.2 system-ui, -apple-system, Arial, sans-serif;
    }
    .legend .row { display: flex; align-items: center; margin-bottom: 4px; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid #3333; }
    .controls label { display: block; margin: 3px 0; }

    .bolt-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #222;
      color: #fff;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      transform: translate(-1px, -1px);
    }

    /* COLORS BY CHARGER TYPE */
    .bolt-l3 { background: #16a34a; }     /* Level 3 → green */
    .bolt-l2 { background: #2563eb; }     /* Level 2 → blue */
    .bolt-solar { background: #facc15; color: #111; } /* Solar → yellow */
    .bolt-public { background: #f97316; } /* Public → orange */

    .leaflet-div-icon { background: transparent; border: none; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var map = L.map('map').setView([40.7128, -74.0060], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // PULL CSV FROM GITHUB RAW (cache-busted)
    var CSV_URL = 'https://raw.githubusercontent.com/FlashE24V/Fleet-Map/main/status_latest_slim.csv?v=' + Date.now();

    function pick(r, keys) {
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        if (r[k] !== undefined && r[k] !== null && r[k] !== '') return r[k];
      }
      return undefined;
    }

    function normalizeStatus(s) {
      if (!s) return 'Unknown';
      var t = ('' + s).toUpperCase();
      if (t.includes('CHARGING')) return 'Charging';
      if (t.includes('OCCUPIED') || t === 'INUSE') return 'Occupied';
      if (t.includes('AVAILABLE')) return 'Available';
      if (t.includes('NEEDS SERVICE') || t.includes('NEED SERVICE')) return 'Needs Service';
      if (t.includes('UNREACHABLE') || t.includes('UNAVAILABLE') || t.includes('DOWN') || t.includes('OFFLINE')) return 'Unreachable';
      return s;
    }

    function chargerTypeFromRow(r) {
      var v = pick(r, ['Charger type (legend)', 'Charger type']);
      if (!v) return 'Level 2';
      var s = ('' + v).toLowerCase();
      if (s.includes('level 3')) return 'Level 3';
      if (s.includes('solar')) return 'Level 2 Solar';
      return 'Level 2';
    }

    function isPublicStation(r) {
      var legend = pick(r, ['Charger type (legend)']);
      if (!legend) return false;
      var t = ('' + legend).toLowerCase();
      return t.indexOf('public stations') !== -1;
    }

    function classForRow(r) {
      if (isPublicStation(r)) return 'bolt-public';
      var ctype = chargerTypeFromRow(r);
      if (ctype === 'Level 3') return 'bolt-l3';
      if (ctype === 'Level 2 Solar') return 'bolt-solar';
      return 'bolt-l2';
    }

    var allRows = [];
    var markers = [];
    var layerGroup = L.layerGroup().addTo(map);

    // Filters (no Faulted)
    var filterState = {
      'Available': true,
      'Charging': true,
      'Occupied': true,
      'Needs Service': true,
      'Unreachable': true
    };
    function passesFilter(statusNorm) {
      if (statusNorm in filterState) return !!filterState[statusNorm];
      return true;
    }

    function makePopup(name, model, last, lat, lon, countsHtml) {
      var apple = 'http://maps.apple.com/?daddr=' + lat + ',' + lon;
      var gmaps = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lon;
      var popup = '<div style="min-width:220px">'
                + '<strong>' + name + '</strong>'
                + (model ? '<br/>Model: ' + model : '')
                + (last ? '<br/>Status: ' + last : '')
                + (countsHtml ? '<br/>' + countsHtml : '')
                + '<br/><div style="margin-top:6px">'
                + '<a href="' + apple + '" target="_blank" rel="noopener">Directions (Apple)</a> &nbsp;|&nbsp; '
                + '<a href="' + gmaps + '" target="_blank" rel="noopener">Directions (Google)</a>'
                + '</div></div>';
      return popup;
    }

    function boltIconHTML(cls) {
      return '<div class="bolt-circle ' + cls + '">⚡</div>';
    }

    function render() {
      layerGroup.clearLayers();
      markers = [];
      var hasAny = false;

      allRows.forEach(function(r){
        var lat = pick(r, ['Lat','lat','Latitude']);
        var lon = pick(r, ['Long','Longitude','lon','long','Lng','lng']);
        if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) return;

        var name  = pick(r, ['stationName','name','Location','Site']) || r.stationID || 'EV Site';
        var model = pick(r, ['stationModel']);

        // Prefer station_label
        var rawStatus = pick(r, ['station_label','LastPortStatus','StationNetworkStatus','status']);
        var statusNorm = normalizeStatus(rawStatus);
        if (!passesFilter(statusNorm)) return;

        var cls = classForRow(r);

        // Optional counts
        var countsHtml = '';
        var pTot = pick(r, ['ports_total']);
        var pA   = pick(r, ['ports_available']);
        var pC   = pick(r, ['ports_charging']);
        var pO   = pick(r, ['ports_occupied']);
        if (pTot !== undefined) {
          countsHtml = 'Ports — total: ' + pTot + ', avail: ' + (pA ?? 0) + ', charging: ' + (pC ?? 0) + ', occupied: ' + (pO ?? 0);
        }

        var icon = L.divIcon({
          className: 'bolt-divicon',
          iconSize: [26, 26],
          html: boltIconHTML(cls)
        });

        var marker = L.marker([lat, lon], { icon: icon })
          .bindPopup(makePopup(name, model, statusNorm, lat, lon, countsHtml));

        marker.addTo(layerGroup);
        markers.push(marker);
        hasAny = true;
      });

      if (hasAny) {
        var group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.15));
      }
    }

    function addLegend() {
      var legend = L.control({position: 'topleft'});
      legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<div class="row"><span class="swatch" style="background:#f97316"></span>Public</div>' +
                        '<div class="row"><span class="swatch" style="background:#2563eb"></span>Level 2</div>' +
                        '<div class="row"><span class="swatch" style="background:#facc15"></span>Level 2 Solar</div>' +
                        '<div class="row"><span class="swatch" style="background:#16a34a"></span>Level 3</div>';
        return div;
      };
      legend.addTo(map);
    }

    function addControls() {
      var ctrl = L.control({position: 'topright'});
      ctrl.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'controls');
        div.innerHTML = '<b>Filter by Status</b>' +
                        '<label><input type="checkbox" data-k="Available" checked/> Available</label>' +
                        '<label><input type="checkbox" data-k="Charging" checked/> Charging</label>' +
                        '<label><input type="checkbox" data-k="Occupied" checked/> Occupied</label>' +
                        '<label><input type="checkbox" data-k="Needs Service" checked/> Needs Service</label>' +
                        '<label><input type="checkbox" data-k="Unreachable" checked/> Unreachable</label>';
        div.addEventListener('change', function(e){
          var t = e.target;
          if (t && t.dataset && t.dataset.k) {
            filterState[t.dataset.k] = t.checked;
            render();
          }
        });
        return div;
      };
      ctrl.addTo(map);
    }

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(res) {
        allRows = res.data || [];
        render();
        addLegend();
        addControls();
      },
      error: function(err){ console.error('CSV parse error:', err); }
    });
  </script>
</body>
</html>
