<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NYC Fleet EV Map (Live via GitHub CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .legend, .controls {
      background: white; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25); font: 14px/1.2 system-ui, -apple-system, Arial, sans-serif;
    }
    .legend .row { display: flex; align-items: center; margin-bottom: 4px; gap: 6px; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; margin-right: 2px; border: 1px solid #3333; }
    .legend .label { flex: 1; }
    .legend .count { color: #6b7280; }

    .controls label { display: block; margin: 3px 0; }

    .bolt-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #222;
      color: #fff;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      transform: translate(-1px, -1px);
    }

    /* COLORS BY TYPE AND SOURCE */
    .bolt-l3 { background: #16a34a; }
    .bolt-l2 { background: #2563eb; }
    .bolt-solar { background: #facc15; color: #111; }
    .bolt-public { background: #f97316; }

    .bolt-flo { background: #a855f7; }      /* DOT Flo = purple */
    .bolt-dotlot { background: #6b7280; }   /* DOT LOT = grey */

    .leaflet-div-icon { background: transparent; border: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([40.7128, -74.0060], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // MAIN + STATIC FILES
    var CSV_URLS = [
      { url: "status_latest_slim.csv?v=" + Date.now(), source: "live" },
      { url: "DOT Flo L2 Curbside Chargers.csv", source: "flo" },
      { url: "DOT LOT AND NISSAN CHARGERS (1).csv", source: "dot_lot" }
    ];

    function pick(r, keys) {
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        if (r[k] !== undefined && r[k] !== null && r[k] !== "") return r[k];
      }
      return undefined;
    }

    function normalizeToInUse(text) {
      if (!text) return "Unknown";
      var t = ("" + text).toUpperCase();
      if (t.includes("AVAILABLE")) return "Available";
      if (t.includes("CHARGING")) return "In Use";
      if (t.includes("OCCUPIED") || t === "INUSE") return "In Use";
      if (t.includes("NEEDS SERVICE")) return "Needs Service";
      if (t.includes("UNREACHABLE") || t.includes("UNAVAILABLE") || t.includes("DOWN") || t.includes("OFFLINE"))
        return "Unreachable";
      return text;
    }

    function deriveStatus(r) {
      var net = pick(r, ["StationNetworkStatus", "networkStatus", "NetworkStatus"]);
      if (net) {
        var n = ("" + net).toUpperCase();
        if (n.includes("UNREACHABLE") || n.includes("UNAVAILABLE") || n.includes("OFFLINE") || n.includes("DOWN")) {
          return "Unreachable";
        }
      }
      var base = pick(r, ["station_label"]) || pick(r, ["LastPortStatus", "status"]);
      return normalizeToInUse(base);
    }

    function isPublicStation(r) {
      var legend = pick(r, ["Charger type (legend)"]);
      if (!legend) return false;
      return ("" + legend).toLowerCase().includes("public stations");
    }

    function chargerTypeFromRow(r) {
      var v = pick(r, ["Charger type (legend)", "Charger type"]);
      if (!v) return "Level 2";
      var t = ("" + v).toLowerCase();
      if (t.includes("level 3")) return "Level 3";
      if (t.includes("solar")) return "Level 2 Solar";
      return "Level 2";
    }

    function classForRow(r) {
      if (r.__source === "flo") return "bolt-flo";
      if (r.__source === "dot_lot") return "bolt-dotlot";

      if (isPublicStation(r)) return "bolt-public";
      var ct = chargerTypeFromRow(r);
      if (ct === "Level 3") return "bolt-l3";
      if (ct === "Level 2 Solar") return "bolt-solar";
      return "bolt-l2";
    }

    function rowHasCoords(r) {
      var lat = pick(r, ["Lat", "lat", "Latitude", "latitude"]);
      var lon = pick(r, ["Long", "Longitude", "lon", "long", "Lng", "lng", "longitude"]);
      return typeof lat === "number" && typeof lon === "number" && !isNaN(lat) && !isNaN(lon);
    }

    function classifyRowForLegend(r) {
      if (!rowHasCoords(r)) return null;

      if (r.__source === "flo") return "DOT Flo L2";
      if (r.__source === "dot_lot") return "DOT LOT";

      if (isPublicStation(r)) return "Public";
      var ct = chargerTypeFromRow(r);
      if (ct === "Level 3") return "Level 3";
      if (ct === "Level 2 Solar") return "Level 2 Solar";
      return "Level 2";
    }

    var allRows = [];
    var layerGroup = L.layerGroup().addTo(map);

    var filterState = {
      Available: true,
      "In Use": true,
      Unreachable: true
    };

    function passesFilter(statusNorm) {
      if (statusNorm in filterState) return filterState[statusNorm];
      return true;
    }

    function makePopup(name, statusText, lat, lon, countsHtml, descText) {
      return (
        '<div style="min-width:220px">' +
        "<strong>" +
        name +
        "</strong>" +
        (statusText ? "<br/>Status: " + statusText : "") +
        (countsHtml ? "<br/>" + countsHtml : "") +
        (descText ? "<br/><b>Rate:</b> " + descText : "") +
        '<br/><div style="margin-top:6px">' +
        '<a href="http://maps.apple.com/?daddr=' +
        lat +
        "," +
        lon +
        '" target="_blank">Apple</a> | ' +
        '<a href="https://www.google.com/maps/dir/?api=1&destination=' +
        lat +
        "," +
        lon +
        '" target="_blank">Google</a>' +
        "</div></div>"
      );
    }

    function boltIconHTML(cls) {
      return '<div class="bolt-circle ' + cls + '">⚡</div>';
    }

    function render() {
      layerGroup.clearLayers();
      var markers = [];
      var hasAny = false;

      allRows.forEach(function (r) {
        var lat = pick(r, ["Lat", "lat", "Latitude", "latitude"]);
        var lon = pick(r, ["Long", "Longitude", "lon", "long", "Lng", "lng", "longitude"]);
        if (typeof lat !== "number" || typeof lon !== "number") return;

        var name =
          pick(r, ["stationName", "name", "Location", "Site", "DOT LOT AND NISSAN CHARGERS"]) ||
          r.stationID ||
          "EV Site";

        var descText = pick(r, ["description", "Description", "rate", "Rate"]);

        var statusNorm = deriveStatus(r);
        if (!passesFilter(statusNorm)) return;

        var cls = classForRow(r);

        var pTot = pick(r, ["ports_total"]);
        var pA = pick(r, ["ports_available"]);
        var pC = pick(r, ["ports_charging"]) || 0;
        var pO = pick(r, ["ports_occupied"]) || 0;

        var inUse =
          (typeof pC === "number" ? pC : parseInt(pC || 0, 10)) +
          (typeof pO === "number" ? pO : parseInt(pO || 0, 10));

        var countsHtml = "";
        if (pTot !== undefined && pTot !== null) {
          var parts = [];
          if (pA !== undefined) parts.push(pA + " Available");
          parts.push(inUse + " In Use");
          countsHtml =
            "<div style='margin-top:6px'><b>Ports:</b> " +
            pTot +
            " total" +
            (parts.length ? " (" + parts.join(" | ") + ")" : "") +
            "</div>";
        }

        var icon = L.divIcon({
          className: "bolt-divicon",
          iconSize: [26, 26],
          html: boltIconHTML(cls)
        });

        var marker = L.marker([lat, lon], { icon: icon }).bindPopup(
          makePopup(name, statusNorm, lat, lon, countsHtml, descText)
        );

        layerGroup.addLayer(marker);
        markers.push(marker);
        hasAny = true;
      });

      if (hasAny) {
        var group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.15));
      }
    }

    var legendControl, legendEl;

    function addLegend() {
      legendControl = L.control({ position: "topleft" });
      legendControl.onAdd = function () {
        legendEl = L.DomUtil.create("div", "legend");

        // *** NEW LEGEND ORDER — DOT at bottom ***
        legendEl.innerHTML =
          '<div class="row"><span class="swatch" style="background:#f97316"></span><span class="label">Public</span><span class="count" id="count-public">(0)</span></div>' +
          '<div class="row"><span class="swatch" style="background:#2563eb"></span><span class="label">Level 2</span><span class="count" id="count-l2">(0)</span></div>' +
          '<div class="row"><span class="swatch" style="background:#facc15"></span><span class="label">Level 2 Solar</span><span class="count" id="count-solar">(0)</span></div>' +
          '<div class="row"><span class="swatch" style="background:#16a34a"></span><span class="label">Level 3</span><span class="count" id="count-l3">(0)</span></div>' +
          '<div class="row"><span class="swatch" style="background:#a855f7"></span><span class="label">DOT Flo L2</span><span class="count" id="count-flo">(0)</span></div>' +
          '<div class="row"><span class="swatch" style="background:#6b7280"></span><span class="label">DOT LOT</span><span class="count" id="count-dotlot">(0)</span></div>';

        return legendEl;
      };
      legendControl.addTo(map);
    }

    function updateLegendCounts() {
      var counts = {
        "DOT Flo L2": 0,
        "DOT LOT": 0,
        Public: 0,
        "Level 2": 0,
        "Level 2 Solar": 0,
        "Level 3": 0
      };

      allRows.forEach(function (r) {
        var bucket = classifyRowForLegend(r);
        if (bucket) counts[bucket] = (counts[bucket] || 0) + 1;
      });

      function set(id, v) {
        var el = legendEl.querySelector("#" + id);
        if (el) el.textContent = "(" + v + ")";
      }

      set("count-public", counts["Public"]);
      set("count-l2", counts["Level 2"]);
      set("count-solar", counts["Level 2 Solar"]);
      set("count-l3", counts["Level 3"]);
      set("count-flo", counts["DOT Flo L2"]);
      set("count-dotlot", counts["DOT LOT"]);
    }

    function addControls() {
      var ctrl = L.control({ position: "topright" });
      ctrl.onAdd = function () {
        var div = L.DomUtil.create("div", "controls");
        div.innerHTML =
          "<b>Filter by Status</b>" +
          '<label><input type="checkbox" data-k="Available" checked/> Available</label>' +
          '<label><input type="checkbox" data-k="In Use" checked/> In Use</label>' +
          '<label><input type="checkbox" data-k="Unreachable" checked/> Unreachable</label>';

        div.addEventListener("change", function (e) {
          var t = e.target;
          if (t && t.dataset && t.dataset.k) {
            filterState[t.dataset.k] = t.checked;
            render();
          }
        });
        return div;
      };
      ctrl.addTo(map);
    }

    // Load CSVs in parallel
    var pending = CSV_URLS.length;

    CSV_URLS.forEach(function (cfg) {
      Papa.parse(cfg.url, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function (res) {
          if (res && res.data) {
            res.data.forEach((r) => {
              r.__source = cfg.source;
              allRow
